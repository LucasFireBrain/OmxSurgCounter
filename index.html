<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cuenta Final ‚Äì Registro de Productos</title>
<style>
body { font-family: Arial, sans-serif; padding: 10px; background: #f7f7f7; }
h2 { text-align: center; }
label { display:block; margin-top:8px; font-weight:bold; }

input, select, button {
  font-size: 16px; padding: 6px; margin: 4px 0;
  width: 100%; box-sizing: border-box;
}
#results {
  border: 1px solid #ccc; background: white;
  position: absolute; width: calc(100% - 12px);
  max-height: 180px; overflow-y: auto; z-index: 10;
}
#results div { padding: 6px; cursor: pointer; }
#results div:hover { background: #e0f0ff; }

table { width: 100%; margin-top: 20px; border-collapse: collapse; background: white; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #eee; }
td.editable { cursor: pointer; background:#fdfdfd; }
button.small-btn { padding: 4px 8px; font-size: 12px; }

.popup {
  display:none; position: fixed; top: 20%; left: 50%;
  transform: translateX(-50%);
  background: #fff; border: 1px solid #999;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  padding: 15px; z-index: 20;
  width: 90%; max-width: 400px;
}
.popup input { width: 100%; padding: 6px; margin-bottom: 6px; }
.popup button { width: 100%; margin-top: 6px; }

#editResults div { padding: 6px; cursor: pointer; }
#editResults div:hover { background: #dbeeff; }

#exportBox {
  margin-top: 15px;
  display: flex; flex-direction: column; align-items: center;
}
.action-btn {
  width: 100%; margin-top: 8px; padding: 10px;
  font-size: 16px; border:none; border-radius:4px;
}
.copy-btn { background:#4CAF50; color:white; }
.download-btn { background:#2196F3; color:white; }
.reset-btn { background:#f44336; color:white; }
</style>
</head>
<body>

<h2>Registro de Productos - Cuenta Final</h2>

<label for="surgerySelect">C√≥digo de cirug√≠a</label>
<select id="surgerySelect">
  <option value="">Seleccione una cirug√≠a...</option>
</select>

<label for="search">Buscar producto</label>
<div style="position:relative">
  <input id="search" type="text" placeholder="Buscar por c√≥digo o descripci√≥n..." disabled>
  <div id="results"></div>
</div>

<label for="qty">Cantidad</label>
<input id="qty" type="number" min="1" value="1" disabled inputmode="numeric">
<button id="addBtn" onclick="addItem()" disabled>Agregar producto</button>

<table id="itemTable">
  <thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Cant.</th><th></th></tr></thead>
  <tbody></tbody>
</table>

<div id="editPopup" class="popup">
  <h3>Reemplazar producto</h3>
  <input id="editSearch" type="text" placeholder="Buscar producto...">
  <div id="editResults"></div>
  <button onclick="closeEdit()">Cerrar</button>
</div>

<div id="qtyPopup" class="popup">
  <h3>Editar cantidad</h3>
  <input id="qtyInputPopup" type="number" inputmode="numeric" min="1">
  <button onclick="saveQty()">Guardar</button>
  <button onclick="closeQty()">Cancelar</button>
</div>

<div id="exportBox">
  <button class="action-btn copy-btn" onclick="copyJSON()">üìã Copiar JSON</button>
  <button class="action-btn download-btn" onclick="downloadJSON()">üíæ Descargar JSON</button>
  <button class="action-btn reset-btn" onclick="resetForm()">üîÅ Nueva cirug√≠a</button>
</div>

<script>
// === Example surgery data ===
const surgeries = [
  { id:"P519-AFU7", list:"A" },
  { id:"P516-RGU0", list:"B" },
  { id:"P516-LAG5", list:"B" },
  { id:"P514-RRE1", list:"B" },
  { id:"P514-PSO8", list:"A" },
  { id:"P512-SES9", list:"B" },
  { id:"P512-RCA1", list:"A" },
  { id:"P509-SES8", list:"B" },
  { id:"P509-SES5", list:"A" },
  { id:"P509-SES4", list:"A" }
];

// === Example product data ===
const products = [
  { global:"P001", A:"LA01", B:"LB01", name:"Aguja Para Microdisecci√≥n" },
  { global:"P002", A:"LA02", B:"LB02", name:"Alambre 0.40 GX" },
  { global:"P003", A:"LA03", B:"LB03", name:"Broca Contra√°ngulo" },
  { global:"P004", A:"LA04", B:"LB04", name:"Broca Larga" },
  { global:"P005", A:"LA05", B:"LB05", name:"Broca Mediana" },
  { global:"P006", A:"LA06", B:"LB06", name:"Broca Peque√±a 1.3 x 47 mm" },
  { global:"P007", A:"LA07", B:"LB07", name:"Distractor Alveolar" },
  { global:"P008", A:"LA08", B:"LB08", name:"Fabricacion PRF (Centrifuga)" },
  { global:"P009", A:"LA09", B:"LB09", name:"Fres√≥n Oval de Carburo" },
  { global:"P010", A:"LA10", B:"LB10", name:"Fres√≥n Oval de Carburo ST" },
  { global:"P011", A:"LA11", B:"LB11", name:"Kit Fr√≠o Continuo" },
  { global:"P012", A:"LA12", B:"LB12", name:"Large Tear Cross Cut Rasp" },
  { global:"P013", A:"LA13", B:"LB13", name:"Prototipo Facial" },
  { global:"P014", A:"LA14", B:"LB14", name:"Punta Cruz Contra√°ngulo" }
];

const surgerySelect = document.getElementById('surgerySelect');
const search = document.getElementById('search');
const qtyInput = document.getElementById('qty');
const addBtn = document.getElementById('addBtn');
const results = document.getElementById('results');

// populate surgeries dropdown
surgeries.forEach(s => {
  const opt = document.createElement('option');
  opt.value = s.id;
  opt.textContent = s.id;
  surgerySelect.appendChild(opt);
});

let currentList = null;
let currentSurgery = null;
const items = [];
let editIndex = null;
let editQtyIndex = null;

// surgery selection
surgerySelect.addEventListener('change', () => {
  const val = surgerySelect.value;
  const found = surgeries.find(s => s.id === val);
  if (found) {
    currentList = found.list;
    currentSurgery = found.id;
    search.disabled = false;
    qtyInput.disabled = false;
    addBtn.disabled = false;
  } else resetForm();
});

// === Search logic ===
search.addEventListener('input', filterProducts);
function filterProducts() {
  const term = search.value.toLowerCase();
  results.innerHTML = '';
  if (!term || !currentList) return;
  products
    .filter(p => p.name.toLowerCase().includes(term)
      || p.global.toLowerCase().includes(term)
      || p[currentList].toLowerCase().includes(term))
    .forEach(p => {
      const div = document.createElement('div');
      div.textContent = `${p[currentList]} ‚Äî ${p.name}`;
      div.onclick = () => selectProduct(p);
      results.appendChild(div);
    });
}
function selectProduct(p) {
  search.value = `${p[currentList]} ‚Äî ${p.name}`;
  results.innerHTML = '';
}

function addItem() {
  const val = search.value.trim();
  const qty = parseInt(qtyInput.value);
  if (!val || !qty) { alert('Seleccione producto y cantidad'); return; }
  const [code] = val.split('‚Äî');
  const p = products.find(x => x[currentList] === code.trim());
  if (!p) { alert('Producto no encontrado'); return; }

  const existing = items.find(it => it.code === p[currentList]);
  if (existing) existing.qty += qty;
  else items.push({ code: p[currentList], name: p.name, qty });

  refreshTable();
  search.value = '';
  qtyInput.value = 1;
}

// === Table rendering ===
function refreshTable() {
  const tbody = document.querySelector('#itemTable tbody');
  tbody.innerHTML = '';
  items.forEach((it, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="editable" onclick="openEdit(${i})">${it.code}</td>
      <td class="editable" onclick="openEdit(${i})">${it.name}</td>
      <td class="editable" onclick="openQty(${i})">${it.qty}</td>
      <td><button class="small-btn" onclick="removeItem(${i})">‚ùå</button></td>`;
    tbody.appendChild(row);
  });
}
function removeItem(i) { items.splice(i,1); refreshTable(); }

// === Edit product popup ===
const popup = document.getElementById('editPopup');
const editSearch = document.getElementById('editSearch');
const editResults = document.getElementById('editResults');

function openEdit(index) {
  editIndex = index;
  popup.style.display = 'block';
  editSearch.value = '';
  editResults.innerHTML = '';
  editSearch.focus();
}
editSearch.addEventListener('input', function() {
  const term = editSearch.value.toLowerCase();
  editResults.innerHTML = '';
  if (!term || !currentList) return;
  products
    .filter(p => p.name.toLowerCase().includes(term)
      || p.global.toLowerCase().includes(term)
      || p[currentList].toLowerCase().includes(term))
    .forEach(p => {
      const div = document.createElement('div');
      div.textContent = `${p[currentList]} ‚Äî ${p.name}`;
      div.onclick = () => replaceProduct(p);
      editResults.appendChild(div);
    });
});
function replaceProduct(p) {
  if (editIndex !== null) {
    items[editIndex].code = p[currentList];
    items[editIndex].name = p.name;
  }
  refreshTable();
  closeEdit();
}
function closeEdit() { popup.style.display = 'none'; }

// === Quantity popup ===
const qtyPopup = document.getElementById('qtyPopup');
const qtyInputPopup = document.getElementById('qtyInputPopup');
function openQty(i) {
  editQtyIndex = i;
  qtyInputPopup.value = items[i].qty;
  qtyPopup.style.display = 'block';
  qtyInputPopup.focus();
}
function saveQty() {
  const val = parseInt(qtyInputPopup.value);
  if (val > 0 && editQtyIndex !== null) {
    items[editQtyIndex].qty = val;
    refreshTable();
  }
  closeQty();
}
function closeQty() { qtyPopup.style.display = 'none'; }

// === Export JSON ===
function getJSONData() {
  return JSON.stringify({
    surgeryID: currentSurgery,
    priceList: currentList,
    items: items
  }, null, 2);
}
function copyJSON() {
  if (!currentSurgery) return alert('Seleccione una cirug√≠a primero');
  navigator.clipboard.writeText(getJSONData())
    .then(() => alert('‚úÖ Copiado al portapapeles'))
    .catch(() => alert('Error al copiar'));
}
function downloadJSON() {
  if (!currentSurgery) return alert('Seleccione una cirug√≠a primero');
  const blob = new Blob([getJSONData()], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${currentSurgery}_finalcount.json`;
  a.click();
}

// === Reset form ===
function resetForm() {
  if (items.length && !confirm("¬øBorrar datos actuales?")) return;
  surgerySelect.value = '';
  search.value = '';
  qtyInput.value = 1;
  search.disabled = true;
  qtyInput.disabled = true;
  addBtn.disabled = true;
  currentSurgery = null;
  currentList = null;
  items.length = 0;
  refreshTable();
}
</script>

</body>
</html>
