<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cuenta Final ‚Äì Registro de Productos</title>
<style>
body { font-family: Arial, sans-serif; padding: 10px; background: #f7f7f7; }
h2 { text-align: center; }
label { display:block; margin-top:8px; font-weight:bold; }

input, select, button {
  font-size: 16px; padding: 6px; margin: 4px 0;
  width: 100%; box-sizing: border-box;
}
#results {
  border: 1px solid #ccc; background: white;
  position: absolute; width: calc(100% - 12px);
  max-height: 180px; overflow-y: auto; z-index: 10;
}
#results div { padding: 6px; cursor: pointer; }
#results div:hover { background: #e0f0ff; }

table { width: 100%; margin-top: 20px; border-collapse: collapse; background: white; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #eee; }
td.editable { cursor: pointer; background:#fdfdfd; }
button.small-btn { padding: 4px 8px; font-size: 12px; }

.popup {
  display:none; position: fixed; top: 20%; left: 50%;
  transform: translateX(-50%);
  background: #fff; border: 1px solid #999;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  padding: 15px; z-index: 20;
  width: 90%; max-width: 400px;
}
.popup input { width: 100%; padding: 6px; margin-bottom: 6px; }
.popup button { width: 100%; margin-top: 6px; }

#editResults div { padding: 6px; cursor: pointer; }
#editResults div:hover { background: #dbeeff; }

#exportBox {
  margin-top: 15px;
  display: flex; flex-direction: column; align-items: center;
}
.action-btn {
  width: 100%; margin-top: 8px; padding: 10px;
  font-size: 16px; border:none; border-radius:4px;
}
.copy-btn { background:#4CAF50; color:white; }
.download-btn { background:#2196F3; color:white; }
.reset-btn { background:#f44336; color:white; }
</style>
</head>
<body>

<h2>Registro de Productos - Cuenta Final</h2>

<label for="surgerySelect">C√≥digo de cirug√≠a</label>
<select id="surgerySelect">
  <option value="">Seleccione una cirug√≠a...</option>
</select>

<label for="search">Buscar producto</label>
<div style="position:relative">
  <input id="search" type="text" placeholder="Buscar por c√≥digo o descripci√≥n..." disabled>
  <div id="results"></div>
</div>

<label for="qty">Cantidad</label>
<input id="qty" type="number" min="1" value="1" disabled inputmode="numeric">
<button id="addBtn" onclick="addItem()" disabled>Agregar producto</button>

<table id="itemTable">
  <thead><tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Cant.</th><th></th></tr></thead>
  <tbody></tbody>
</table>

<div id="editPopup" class="popup">
  <h3>Reemplazar producto</h3>
  <input id="editSearch" type="text" placeholder="Buscar producto...">
  <div id="editResults"></div>
  <button onclick="closeEdit()">Cerrar</button>
</div>

<div id="qtyPopup" class="popup">
  <h3>Editar cantidad</h3>
  <input id="qtyInputPopup" type="number" inputmode="numeric" min="1">
  <button onclick="saveQty()">Guardar</button>
  <button onclick="closeQty()">Cancelar</button>
</div>

<div id="exportBox">
  <button class="action-btn copy-btn" onclick="copyJSON()">üìã Copiar JSON</button>
  <button class="action-btn download-btn" onclick="downloadJSON()">üíæ Descargar JSON</button>
  <button class="action-btn reset-btn" onclick="resetForm()">üîÅ Nueva cirug√≠a</button>
</div>

<script>
// === Load external JSON files dynamically (with debug logs) ===
// 1Ô∏è‚É£ global_master.json ‚Üí static data (products)
// 2Ô∏è‚É£ daily_data.json    ‚Üí dynamic data (surgeries)
// Both files live inside the /data folder.

let surgeries = [];
let products = [];
let currentHospital, currentDoctor, currentPatient, currentNotes;


// helper function to print sections clearly
function debugLog(label, value) {
  console.log(`üß© ${label}:`, value);
}

// --- STEP 1: Load the stable master file (products) ---
fetch("./data/global_master.json")
  .then(res => {
    debugLog("Fetching global_master.json", res.status);
    if (!res.ok) throw new Error("Failed to load global_master.json");
    return res.json();
  })
  .then(masterData => {
    debugLog("Raw masterData", masterData);

    // handle both possible structures (array or {products: [...]})
    if (Array.isArray(masterData)) {
      products = masterData;
      debugLog("Detected format", "Array [] at root");
    } else if (masterData.products) {
      products = masterData.products;
      debugLog("Detected format", "Object with .products");
    } else {
      debugLog("Detected format", "Unknown structure");
      products = [];
    }

    debugLog("‚úÖ Products loaded", products.length);

    // Load daily data next
    return fetch("./data/daily_data.json");
  })

  // --- STEP 2: Load the daily surgeries file ---
  .then(res => {
    debugLog("Fetching daily_data.json", res.status);
    if (!res.ok) throw new Error("Failed to load daily_data.json");
    return res.json();
  })
  .then(dailyData => {
    debugLog("Raw dailyData", dailyData);

    if (Array.isArray(dailyData)) {
      surgeries = dailyData;
      debugLog("Detected format", "Array [] at root");
    } else if (dailyData.surgeries) {
      surgeries = dailyData.surgeries;
      debugLog("Detected format", "Object with .surgeries");
    } else {
      debugLog("Detected format", "Unknown structure");
      surgeries = [];
    }

    debugLog("‚úÖ Surgeries loaded", surgeries.length);

    // Populate dropdown once both files are loaded
    populateSurgeries();
  })

  // --- STEP 3: Error handling ---
  .catch(err => {
    console.error("‚ùå Error loading data files:", err);
    alert("‚ö†Ô∏è No se pudieron cargar los archivos de datos. Revisa la consola.");
  });


// === Populate the surgery dropdown ===
// This remains identical ‚Äî we just call it after both files are loaded.
function populateSurgeries() {
  const surgerySelect = document.getElementById('surgerySelect');
  surgerySelect.innerHTML = '<option value="">Seleccione una cirug√≠a...</option>';
  surgeries.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.id;
    surgerySelect.appendChild(opt);
  });
}


const surgerySelect = document.getElementById('surgerySelect');
const search = document.getElementById('search');
const qtyInput = document.getElementById('qty');
const addBtn = document.getElementById('addBtn');
const results = document.getElementById('results');

// populate surgeries dropdown
surgeries.forEach(s => {
  const opt = document.createElement('option');
  opt.value = s.id;
  opt.textContent = s.id;
  surgerySelect.appendChild(opt);
});

let currentList = null;
let currentSurgery = null;
const items = [];
let editIndex = null;
let editQtyIndex = null;

// surgery selection
surgerySelect.addEventListener('change', () => {
  const val = surgerySelect.value;
  const found = surgeries.find(s => s.id === val);
  if (found) {
    currentList = found.list;
    currentSurgery = found.id;
    currentHospital = found.hospital;
    currentDoctor   = found.doctor;
    currentPatient  = found.patient;
    currentNotes    = found.notes || "";
    search.disabled = false;
    qtyInput.disabled = false;
    addBtn.disabled = false;
  } else resetForm();
});

// === Search logic ===
search.addEventListener('input', filterProducts);
function filterProducts() {
  const term = search.value.toLowerCase();
  results.innerHTML = '';
  if (!term || !currentList) return;
  products
    .filter(p => p.name.toLowerCase().includes(term)
      || p.global.toLowerCase().includes(term)
      || p[currentList].toLowerCase().includes(term))
    .forEach(p => {
      const div = document.createElement('div');
      div.textContent = `${p[currentList]} ‚Äî ${p.name}`;
      div.onclick = () => selectProduct(p);
      results.appendChild(div);
    });
}
function selectProduct(p) {
  search.value = `${p[currentList]} ‚Äî ${p.name}`;
  results.innerHTML = '';
}

function addItem() {
  const val = search.value.trim();
  const qty = parseInt(qtyInput.value);
  if (!val || !qty) { alert('Seleccione producto y cantidad'); return; }
  const [code] = val.split('‚Äî');
  const p = products.find(x => x[currentList] === code.trim());
  if (!p) { alert('Producto no encontrado'); return; }

  const existing = items.find(it => it.code === p[currentList]);
  if (existing) existing.qty += qty;
  else items.push({ code: p[currentList], name: p.name, qty });

  refreshTable();
  search.value = '';
  qtyInput.value = 1;
}

// === Table rendering ===
function refreshTable() {
  const tbody = document.querySelector('#itemTable tbody');
  tbody.innerHTML = '';
  items.forEach((it, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="editable" onclick="openEdit(${i})">${it.code}</td>
      <td class="editable" onclick="openEdit(${i})">${it.name}</td>
      <td class="editable" onclick="openQty(${i})">${it.qty}</td>
      <td><button class="small-btn" onclick="removeItem(${i})">‚ùå</button></td>`;
    tbody.appendChild(row);
  });
}
function removeItem(i) { items.splice(i,1); refreshTable(); }

// === Edit product popup ===
const popup = document.getElementById('editPopup');
const editSearch = document.getElementById('editSearch');
const editResults = document.getElementById('editResults');

function openEdit(index) {
  editIndex = index;
  popup.style.display = 'block';
  editSearch.value = '';
  editResults.innerHTML = '';
  editSearch.focus();
}
editSearch.addEventListener('input', function() {
  const term = editSearch.value.toLowerCase();
  editResults.innerHTML = '';
  if (!term || !currentList) return;
  products
    .filter(p => p.name.toLowerCase().includes(term)
      || p.global.toLowerCase().includes(term)
      || p[currentList].toLowerCase().includes(term))
    .forEach(p => {
      const div = document.createElement('div');
      div.textContent = `${p[currentList]} ‚Äî ${p.name}`;
      div.onclick = () => replaceProduct(p);
      editResults.appendChild(div);
    });
});
function replaceProduct(p) {
  if (editIndex !== null) {
    items[editIndex].code = p[currentList];
    items[editIndex].name = p.name;
  }
  refreshTable();
  closeEdit();
}
function closeEdit() { popup.style.display = 'none'; }

// === Quantity popup ===
const qtyPopup = document.getElementById('qtyPopup');
const qtyInputPopup = document.getElementById('qtyInputPopup');
function openQty(i) {
  editQtyIndex = i;
  qtyInputPopup.value = items[i].qty;
  qtyPopup.style.display = 'block';
  qtyInputPopup.focus();
}
function saveQty() {
  const val = parseInt(qtyInputPopup.value);
  if (val > 0 && editQtyIndex !== null) {
    items[editQtyIndex].qty = val;
    refreshTable();
  }
  closeQty();
}
function closeQty() { qtyPopup.style.display = 'none'; }

// === Export JSON ===
function getJSONData() {
  return JSON.stringify({
    id: currentSurgery,
    list: currentList,
    hospital: currentHospital,
    doctor: currentDoctor,
    patient: currentPatient,
    notes: currentNotes,
    items: items
  }, null, 2);
}
function copyJSON() {
  if (!currentSurgery) return alert('Seleccione una cirug√≠a primero');
  navigator.clipboard.writeText(getJSONData())
    .then(() => alert('‚úÖ Copiado al portapapeles'))
    .catch(() => alert('Error al copiar'));
}
function downloadJSON() {
  if (!currentSurgery) return alert('Seleccione una cirug√≠a primero');
  const blob = new Blob([getJSONData()], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${currentSurgery}_finalcount.json`;
  a.click();
}

// === Reset form ===
function resetForm() {
  if (items.length && !confirm("¬øBorrar datos actuales?")) return;
  surgerySelect.value = '';
  search.value = '';
  qtyInput.value = 1;
  search.disabled = true;
  qtyInput.disabled = true;
  addBtn.disabled = true;
  currentSurgery = null;
  currentList = null;
  items.length = 0;
  refreshTable();
}
</script>

</body>
</html>
